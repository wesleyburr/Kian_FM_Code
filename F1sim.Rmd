---
title: "F1 simulation"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
load("SimulationDataF1.RData")
```
Here is the counter matrix for the new F1 statistic. The SNR is unrealistically high (20 here), but we can see that it works fairly well under pretty ideal conditions, which is a start. This time, I only used degrees 0 to 3, but the results should (I think) be pretty similar if more degrees are used. As before the column number is the degree + 1 and the row number is the proportion of the band $(f-W,f+W)$ that the modulating polynomial lives in. So if $\rho$ is the proportion of the band, then in row 1 we have $\rho = \frac{1-1}{5}=0$, in row 2 we have $\rho = \frac{2-1}{5}=0.2$ and so on. Then if $f$ is the carrier frequency (here 0.2) plus modulating polynomial so that the instantaneous frequency is $\psi(t) = f + \phi'(t)$, we have $\psi: [0,N-1] \to (f-\rho W, f+\rho W )$. The embedded sinusoid has the form $\exp \{ i\theta(t)\} = \exp\{ i2\pi \int_{0}^t \psi(s) \text{d}s \} = \exp\{ i2\pi ft + i2\pi \phi(t) - i2\pi\phi(0)\}$ (I guess we need $\phi(0) = 0$), so that $\psi(t) = \frac{1}{2\pi} \theta'(t)$.
```{r}
F1countermatrix
```
For no and "low" modulation, the zero degree F1 statistic did the job and found a max in the band $(f-W,f+W)$ (this should actually probably be done again, but with $(f-\rho W, f+\rho W )$). When the modulation increases, the performance of the zero degree statistic decreases, but the degree 2 statistic manages to find a maximum in the band most of the time. 


```{r}
Fcounterlist
```
The Harmonic F statistic performs similarly to the 0 degree F1 and should probably replace the 0 degree F1 statistic. This row of numbers is to be read the same as the first column of the F1 counter matrix. That is, the first number is the amount of times the max F statistic was in the band $(f-W,f+W)$ with no modulation, then "low" modulation and so on.


There are a couple of problems though. First is the zero degree F1. It seems to split around the carrier frequency and was probably coded in a strange way, so that could be why. I wasn't fully sure how to code the 0 degree one since all the others involved a difference of order $P$ and order $P+1$ in the numerator.
```{r}
plot(freq, F1ave[1,1,], type = 'l', log = 'y')
plot(freq, F1ave[1,1,], type = 'l', xlim = c(0.15,0.25), log = 'y')
abline(v = c(f-W,f+W), lty = 2, col = 2, lwd = 2)
```
The other issue is spurious lines. On average, there doesn't seem to be a huge problem with the degree 2 F1 statistic in higher levels of modulation. It is doing more or less what I expected, which is a broad peak inside the band rather than a sharp, narrow spike right at the carrier frequency.
```{r}
plot(freq, F1ave[5,3,], type = 'l', log = 'y')
title("Average F1, degree 2, 0.8 of the band")
plot(freq, F1ave[5,3,], type = 'l', log = 'y', xlim = c(0.15,0.25))
abline(v = c(f-W,f+W), lty = 2, col = 2, lwd = 2)
```
However, that is on average. If we look at any one simulation, there are often many spurious lines.
```{r}
plot(freq, F1array[3,,6,42], type = 'l')
title("F1, degree 2, proportion of the band = 1, one realization")
abline(h = qf(1-1/ndata, 2, 2*(nord-3)), lty = 2, lwd = 2, col = 2)
```
The peak around the carrier frequency is much stronger than any of the others, but again, this is in a fairly unrealistic situation so the spurious lines could be a worse problem with real data. Dave has a paper from 2018 where he is able to reject some of the spurious lines using some sort of quadratic inverse thing. Perhaps a similar approach can be used here. 
EDIT: This is now better with 1 and $K-P$ degrees of freedom
```{r}
plot(freq, F1array[3,,6,100], type = 'l')
title("F1, degree 2, proportion of the band = 1, one realization")
abline(h = qf(1-1/ndata, 1, nord-3), lty = 2, lwd = 2, col = 2)
```

```{r}
plot(freq, F1array[3,,6,42], type = 'l', xlim = c(0.15,0.25))
abline(v = c(f-W,f+W), lty = 2, lwd = 2, col = 2)
```
Check the degrees of freedom:
```{r}
plot(qf(seq(0,0.99, length.out = 100),1,nord-4), F1sort[4,99,6,])
abline(a=0,b=1)

plot(qf(seq(0,0.99, length.out = 100),2,2*(nord-4)), F1sort[4,99,6,])
abline(a=0,b=1)

plot(qf(seq(0,0.99, length.out = 100),1,nord-2), F1sort[2,678,6,])
abline(a=0,b=1)

plot(qf(seq(0,0.99, length.out = 100),2,2*(nord-2)), F1sort[2,678,6,])
abline(a=0,b=1)

plot(qf(seq(0,0.99, length.out = 100),1,nord-1), F1sort[1,234,6,])
abline(a=0,b=1)

plot(qf(seq(0,0.99, length.out = 100),2,2*(nord-1)), F1sort[1,234,6,])
abline(a=0,b=1)

plot(qf(seq(0,0.99, length.out = 100),1,nord-3), F1sort[3,1000,6,])
abline(a=0,b=1)

plot(qf(seq(0,0.99, length.out = 100),2,2*(nord-3)), F1sort[3,1000,6,])
abline(a=0,b=1)

plot(qf(seq(0,0.99, length.out = 100),1,nord-4), F1sort[4,f.ind,6,])
abline(a=0,b=1)

plot(qf(seq(0,0.99, length.out = 100),1,nord-2), F1sort[2,f.ind,6,])
abline(a=0,b=1)
```

Comparison between my F statistic and Dave's F1.

```{r}
rm(list = ls())
load("SimulationDataF1compare.RData")
```

First the counter matrices. The first is the harmonic F, then Dave's F1 and then mine. The SNR is artifically high.

```{r}
Fcounterlist

F1DJTcountermatrix

F1countermatrix
```

Some plots. These are averages and qq plots.

```{r}
plot(freq, F1DJTave[5,3,], type = 'l')
abline( h = qf(1-1/ndata, 2, 2*(nord-3)), lty = 2, col = 2)

plot(freq, F1ave[5,3,], type = 'l')
abline( h = qf(1-1/ndata, 1, nord-3), lty = 2, col = 2)

plot(qf(seq(0,0.99, length.out = 100),1,nord-1), F1sort[1,234,6,])
abline(a=0,b=1)

plot(qf(seq(0,0.99, length.out = 100),1,nord-P), F1sort[2,3567,6,])
abline(a=0,b=1)

plot(qf(seq(0,0.99, length.out = 100),1,nord-2), F1sort[3,1004,6,])
abline(a=0,b=1)

plot(qf(seq(0,0.99, length.out = 100),1,nord-3), F1sort[4,589,6,])
abline(a=0,b=1)

plot(qf(seq(0,0.99, length.out = 100),1,nord-1), F1sort[2,f.ind,6,])
abline(a=0,b=1)

plot(qf(seq(0,0.99, length.out = 100),1,nord-2), F1sort[3,f.ind,6,])
abline(a=0,b=1)

plot(qf(seq(0,0.99, length.out = 100),1,nord-3), F1sort[4,f.ind,6,])
abline(a=0,b=1)

plot(qf(seq(0,0.99, length.out = 100),1,nord-2), F1sort[2,3567,6,])
abline(a=0,b=1)
```    
The F statistics at the carrier frequency but the wrong degree do not appear to be distributed as $F(1,K-P)$, though the ones at a different frequency and different degree do.

```{r}
plot(freq, F1ave[6,2,], type = 'l', log = 'y')
abline( h = c( mean(F1ave[6,2,]), (nord-2) / (nord - 4)) , lty = 2, col = c(4,2), lwd = 2)

plot(freq, F1ave[6,2,], type = 'l', log = 'y')
abline( h = c( mean(F1ave[6,2,]), (nord-P) / (nord - P - 2)) , lty = 2, col = c(4,2), lwd = 2)
abline( v = range(band), col = 3, lty = 2)

plot(freq, F1ave[6,2,], type = 'l', log = 'y', xlim = c(0.18,0.22))
abline( h = c( mean(F1ave[6,2,]), (nord-P) / (nord - P - 2)) , lty = 2, col = c(4,2), lwd = 2)
abline( v = c(f-2*W,f+2*W), col = 3, lty = 2)
alpha <- 0.01
abline(h = qf(alpha/2, 1, nord - 2), lty = 2, col = 4)
sig <- sd(F1ave[6,2,])
abline(h = mean(F1ave[6,2,]) - 2*sig, lty = 2, col = 5)

```

SNR stuff

```{r}
rm(list = ls())
load("SimulationDataF1compareSNR.RData")
```

```{r}
f.ind <- which.min(abs(freq - f))
plot(freq, F1DJTave[3,3,], type = 'l')
abline( h = qf(1-1/ndata, 2, 2*(nord-3)), lty = 2, col = 2)

plot(freq, F1ave[3,3,], type = 'l')
abline( h = qf(1-1/ndata, 1, nord-3), lty = 2, col = 2)

plot(qf(seq(0,0.99, length.out = 1000),1,nord-1), F1sort[1,234,3,])
abline(a=0,b=1)

#return to this P thing later
#plot(qf(seq(0,0.99, length.out = 1000),1,nord-P), F1sort[2,3567,3,])
#abline(a=0,b=1)

#possible mistake here. Fix later
plot(qf(seq(0,0.99, length.out = 1000),1,nord-2), F1sort[2,1004,3,])
abline(a=0,b=1)

plot(qf(seq(0,0.99, length.out = 1000),1,nord-3), F1sort[3,589,3,])
abline(a=0,b=1)

plot(qf(seq(0,0.99, length.out = 1000),1,nord-1), F1sort[1,f.ind,3,])
abline(a=0,b=1)

plot(qf(seq(0,0.99, length.out = 1000),1,nord-2), F1sort[2,f.ind,3,])
abline(a=0,b=1)

plot(qf(seq(0,0.99, length.out = 1000),1,nord-3), F1sort[3,f.ind,3,])
abline(a=0,b=1)

plot(qf(seq(0,0.99, length.out = 1000),1,nord-2), F1sort[2,3567,3,])
abline(a=0,b=1)
```

Now Dave's. The results are basically the same for all levels of SNR

```{r}
plot(qf(seq(0,0.99, length.out = 1000),1,nord-1), F1DJTsort[1,234,1,])
abline(a=0,b=1)

plot(qf(seq(0,0.99, length.out = 1000),1,nord-2), F1DJTsort[2,1004,1,])
abline(a=0,b=1)

plot(qf(seq(0,0.99, length.out = 1000),1,nord-3), F1DJTsort[3,589,1,])
abline(a=0,b=1)

plot(qf(seq(0,0.99, length.out = 1000),1,nord-4), F1DJTsort[4,234,1,])
abline(a=0,b=1)

plot(qf(seq(0,0.99, length.out = 1000),1,nord-2), F1DJTsort[5,1004,1,])
abline(a=0,b=1)

plot(qf(seq(0,0.99, length.out = 1000),1,nord-3), F1DJTsort[6,589,1,])
abline(a=0,b=1)
```

```{r}
x <- c(1,2,3)
m <- mean(x)
t <- (m - 5) / sd(x)
```

